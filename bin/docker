#!/usr/bin/env bash

__help() {
cat <<END_OF_HELP
Usage: ${0} <commands> [options]                  <> - required parameters
Where commands are:                               [] - optional parameters

  build <image-tag> [docker-build-options]
            Builds a new container image using 'docker image build' command.
            See 'docker image build --help' for a list of supported options.

  run <image-tag> [shell-command-and-options]
            Run a command in a new container with 'docker container run'.
            Container-run options are preconfigured, user input is executed.

  attach <image-tag> [docker-attach-options]
            Attaches input/output streams to an already running container.
            See 'docker container attach --help' for all supported options.

  exec <image-tag> [shell-command-and-options]
            Executes a command in a container which launched from the image.
            See 'docker container exec --help' for more information.

  stop <image-tag> [docker-stop-options]
            Stops all running containers based on the application's image.
            See 'docker container stop --help' for more information.

END_OF_HELP
}


DOCKER_CMD="${1:-help}" && shift
TAG="${1:-latest}" && shift
IMAGE="ursadk/getopts_long:${TAG}"

case "${DOCKER_CMD}" in
  'b'|'build')
    export DOCKER_BUILDKIT=1
    docker image build --tag "${IMAGE}" --target "${TAG}" "${@}" "${PWD}";
    ;;
  'r'|'run')
    if [ -t 1 ]; then
      # Runs when the script is executed interactively
      docker container run --rm --init -it -v "${PWD}:/mnt" "${IMAGE}" "${@}"
    else
      # Runs when the script is executed by GitHub Actions
      echo docker container run --rm --init -v "${PWD}:/mnt" "${IMAGE}" "${@}"
      docker container run --rm --init -v "${PWD}:/mnt" "${IMAGE}" "${@}"
    fi
    ;;
  'a'|'attach')
    CONTAINER_ID="$(docker container ls -qlf "ancestor=${IMAGE}")"
    docker container attach "${@}" "${CONTAINER_ID}"
    ;;
  'e'|'exec')
    CONTAINER_ID="$(docker container ls -qlf "ancestor=${IMAGE}")"
    if [ -t 1 ]; then
      # Runs when the script is executed interactively
      docker container exec -it "${CONTAINER_ID}" "${@}"
    else
      # Runs when the script is executed by GitHub Actions
      docker container exec "${CONTAINER_ID}" "${@}"
    fi
    ;;
  's'|'stop')
    CONTAINER_IDS="$(docker container ls -qf "ancestor=${IMAGE}")"
    [[ -n "${CONTAINER_IDS}" ]] && docker container stop "${@}" "${CONTAINER_IDS}"
    ;;
  '-?'|'--help'|'help')
    __help >&2
    exit 1
    ;;
  *)
    echo "${0}: Unknown command -- ${DOCKER_CMD}" >&2
    exit 1
    ;;
esac
